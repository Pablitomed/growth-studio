name: ðŸš€ Growth Studio - CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ================================================
  # BUILD & TEST
  # ================================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¥ Instalar dependÃªncias
        run: bun install --frozen-lockfile

      - name: ðŸ”§ Gerar Prisma Client
        run: bunx prisma generate

      - name: ðŸ” Lint
        run: bun run lint

      - name: ðŸ—ï¸ Build
        run: bun run build

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: |
            .next/
            public/
            prisma/
            package.json
            bun.lock

  # ================================================
  # DOCKER BUILD & PUSH
  # ================================================
  docker:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Login no Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Extrair metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build e Push Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ================================================
  # DEPLOY TO VPS
  # ================================================
  deploy:
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy na VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Iniciando deploy..."
            
            # Criar diretÃ³rio se nÃ£o existe
            mkdir -p /opt/growth-studio
            cd /opt/growth-studio
            
            # Download da imagem
            docker pull ghcr.io/${{ github.repository }}:latest
            
            # Parar container antigo
            docker-compose down || true
            
            # Atualizar docker-compose se necessÃ¡rio
            if [ ! -f docker-compose.yml ]; then
              cat > docker-compose.yml << 'EOF'
version: '3.8'
services:
  growth-studio:
    image: ghcr.io/${{ github.repository }}:latest
    container_name: growth-studio
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/growth-studio.db
      - NEXT_PUBLIC_APP_URL=${{ secrets.APP_URL }}
      - N8N_API_KEY=${{ secrets.N8N_API_KEY }}
    volumes:
      - growth-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  growth-data:
EOF
            fi
            
            # Iniciar novo container
            docker-compose up -d
            
            # Limpar imagens antigas
            docker image prune -af --filter "until=24h"
            
            echo "âœ… Deploy concluÃ­do!"
          ENDSSH

      - name: ðŸ¥ Health Check
        run: |
          echo "Aguardando aplicaÃ§Ã£o iniciar..."
          sleep 30
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_IP }}:3000/api/health)
          
          if [ "$response" = "200" ]; then
            echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel!"
          else
            echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu (HTTP $response)"
            exit 1
          fi

      - name: ðŸ“¢ NotificaÃ§Ã£o de Sucesso
        if: success()
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ðŸš€ Growth Studio deploy concluÃ­do!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ðŸš€ Deploy ConcluÃ­do com Sucesso!*\n\nâ€¢ *Ambiente:* Production\nâ€¢ *Branch:* ${{ github.ref_name }}\nâ€¢ *Commit:* ${{ github.sha }}\nâ€¢ *Autor:* ${{ github.actor }}"
                  }
                }
              ]
            }' || true

  # ================================================
  # DEPLOY N8N WORKFLOWS
  # ================================================
  deploy-n8n:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Importar Workflows N8N
        run: |
          for file in n8n-templates/*.json; do
            if [ -f "$file" ]; then
              echo "Importando: $file"
              curl -X POST "${{ secrets.N8N_URL }}/api/v1/workflows" \
                -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d @"$file" || echo "Aviso: NÃ£o foi possÃ­vel importar $file"
            fi
          done
        continue-on-error: true
